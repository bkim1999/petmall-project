  <!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/layout/header :: head('리뷰 수정')}"></head>
<style>
  h1 {
    margin: 100px 0 50px 0;
    text-align:center;
  }
  #wrapper {
    width: 1000px;
    height: 1000px;
    margin: 0px auto;
  }
  .preview-area {
    margin: 30px;
    padding: 10px;
    border: 1px dotted gray;
  }
  .preview-list {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .preview-area.is-valid{
    border: solid 2px green;
  }
  .preview-area.is-invalid{
    border: solid 2px red;
  }
  
  .add-image-area, .preview-image-area {
    border: 1px  gray;
    border-style: dashed;
    border-radius: 10%;
    padding: 10px;
    margin: 10px;
  }
  .add-image-area:hover, .preview-image-area:hover {
    cursor: pointer;
    background-color: lightgray;
  }
  .btn_delete_image:hover {
    font-size: 20px;
    font-weight: bold;
  }
  .preview-image {
    width: 100px;
    height: 100px;
    object-fit: contain;
    margin: 1px;
  }
  .btn_delete_image {
    text-align: center;
    color: red;
    margin: 0;
    height: 30px;
  }
  .btn-group {
    margin: 10px auto;
    width: 150px;
  }
  .star {
    border: none;
    background-color: unset;
    width: 50px;
    font-size: 30px;
    padding: 10px;
    color: gold;
  }
  .product-info {
    margin: 50px auto;
    width: 500px;
    border: solid 1px black;
  }
  .product-info:hover {
    cursor: pointer;
  }
  .thumbnail {
    width: 100px;
    height: 100px;
    object-fit: contain;
    text-align: center;
  }
</style>

<body>
  <div th:replace="~{layout/header :: header}"></div>
  <div id="wrapper">
    <div>
      <div class="d-flex product-info">
        <img class="thumbnail" th:if="${map.productImagePath != null}" th:src="${map.productImagePath}">
        <img class="thumbnail" th:if="${map.productImagePath == null}" th:src="@{/image/no_image.png}">
        <div class="align-middle">
          <div th:text="${map.productName}"></div>
          <div th:text="${map.optionName}"></div>
        </div>
      </div>
      <div class="btn-group d-flex justify-content-center">
        <th:block th:each="num:${#numbers.sequence(1, 5)}">
          <button th:if="${num} <= ${map.reviewRating}" class="star">★</button>
          <button th:if="${num} > ${map.reviewRating}" class="star">☆</button>
        </th:block>
      </div>
    </div>
    <form id="frm_add_review" method="post" th:action="@{/review/editReview.do}" enctype="multipart/form-data">
      <div class="form-group">
        <label for="reviewTitle" class="form-label mt-4">리뷰제목</label>
        <input type="text" class="form-control" name="reviewTitle" id="reviewTitle" th:value="${map.reviewTitle}">
        <div class="invalid-feedback"></div>
      </div>
      <div class="form-group">
        <label for="reviewContents" class="form-label mt-4">리뷰내용</label>
        <textarea class="form-control" name="reviewContents" id="reviewContents" th:text="${map.reviewContents}"></textarea>
        <div class="invalid-feedback"></div>
      </div>
      <div class="form-group mt-3">
        <label for="files" class="form-label mt-4">리뷰사진</label>
        <div class="preview-area" id="review_image_area">
          <div class="mb-2">리뷰사진 미리보기</div>
          <div class="preview-list">
            <input type="file" class="form-control image-input d-none" name="review_image" id="review_image">
            <th:block th:if="${not #strings.isEmpty(map.reviewImagePath)}">
              <div class="preview-image-area">
                <img class="preview-image" th:src="${map.reviewImagePath}">
                <div class="btn_delete_image" style="height: 30px;">X</div>
              </div>
            </th:block>
            <th:block th:if="${#strings.isEmpty(map.reviewImagePath)}">
              <div class="add-image-area">
                <img class="preview-image" src="/image/plus_sign.png">
                <div class="text-center mb-2" style="height: 30px;">새 이미지 추가</div>
              </div>
            </th:block>
          </div>
        </div>
        <div class="invalid-feedback"></div>
      </div>
      <div class="d-grid mb-5">
        <input type="hidden" name="reviewNo" th:value="${map.reviewNo}">
        <input type="hidden" name="optionNo" th:value="${map.optionNo}">
        <input type="hidden" name="productNo" th:value="${map.productNo}">
        <input type="hidden" name="userNo" th:value="${map.userNo}">
        <input type="hidden" id="reviewRating" name="reviewRating" th:value="${map.reviewRating}">
        <input type="hidden" id="deletedImage" name="deletedImage">
        <button type="button" id="btn_edit_review" class="btn btn-lg btn-primary">리뷰 수정</button>
      </div>
    </form>
  </div>
  <div th:replace="~{layout/footer :: footer}"></div>

</body>


<script th:inline="javascript">
 
  const fnToggleValid = (input, isInvaild, feedback) => {
    if(isInvaild){
      if(!input.hasClass('is-invalid')){
        input.removeClass('is-valid');
        input.addClass('is-invalid');
      }
      input.siblings('.invalid-feedback').text(feedback);
    } else {
      if(!input.hasClass('is-valid')){
        input.removeClass('is-invalid');
        input.addClass('is-valid');
      }
    }
  }

  const fnFileCheck = () => {
    $('#thumbnail, #product_images').change((ev) => {
      let maxSize = 1024 * 1024 * 100;
      let maxSizePerFile = 1024 * 1024 * 10;
      let totalSize = 0;
      let files = ev.target.files;
      for(let i = 0; i < files.length; i++){
        totalSize += files[i].size;
        if(files[i].size > maxSizePerFile){
          alert('각 첨부파일의 최대 크기는 10MB입니다.');
          $(ev.target).val('');
          return;
        }
      }
      if(totalSize > maxSize){
        alert('전체 첨부파일의 최대 크기는 100MB입니다.');
        $(ev.target).val('');
        return;
      }
    });
  }
  

  
  // '새 이미지 추가' 요소 클릭 시 파일 input 클릭
  const fnOpenFileSelect = () => {
    $(document).on('click', '.add-image-area', function(){
      $(this).siblings('.image-input').click();
    });
  }
  
  // index와 이미지 src를 받아 출력하는 함수
  const fnPreviewImage = (index, imageSrc, target) =>{
    let str = '<div class="preview-image-area" index="' + index + '" draggable="true">';
    str += '  <img class="preview-image" src="' + imageSrc + '" draggable="false">';
    str += '  <div class="btn_delete_image" style="height: 30px;">X</div>';
    str += '</div>';
    target.before(str);
  }
  
  const fnAddReviewImage = () => {
    $(document).on('change', '#review_image_area .image-input', function(ev){
      let target = $('#review_image_area .add-image-area');
      console.log(target);
      fnPreviewImage(-1, URL.createObjectURL($(this)[0].files[0]), target);
      target.remove();
      fnToggleValid($('#thumbnail_area'), false, '');
    });
  }
  const fnDeleteReviewImage = () => {
    $(document).on('click', '#review_image_area .btn_delete_image', function(ev){
      if(!confirm('이 이미지를 삭제하시겠습니까?')){
        return;
      }
      if($('#review_image')[0].files.length === 0) {
        let imagePath = /*[[${map.reviewImagePath}]]*/ 0;
        $('#deletedImage').val(imagePath);
      }
      let str = '<div class="add-image-area">';
      str += '  <img class="preview-image" src="/image/plus_sign.png">';
      str += '  <div class="text-center mb-2" style="height: 30px;">새 이미지 추가</div>';
      str += '</div>';
      $(this).parents('.preview-list').append(str);
      $(this).parent().siblings('.image-input').val('');
      $(this).parent().remove();
    });
  }
  
  fnAddReviewImage();
  fnDeleteReviewImage();
  
  const fnCheckInput = () => {
    $(document).on('keyup', 'input[type="text"], textarea', function(){
      fnToggleValid($(this), $(this).val().length > 200, ' * 문자수는 최대 200자입니다.');
    });
  }
  
  const fnCheckRequired = () => {
    $(document).on('click', '#btn_edit_review', function(){
      
      // 평점 입력 여부 체크
      if($('#reviewRating').val() == 0){
        alert('평점을 입력해주세요.');
        return;
      }
      
      // 글자수 체크
      $.each($('input[type="text"], textarea'), (i, input) => {
        fnToggleValid($(input), $(input).val().length > 200, ' * 문자수는 최대 200자입니다.');
      });
      
      // 이미지 첨부항목 첨부파일 유형이 이미지인지 체크
      var files = Array.from($('#review_image').prop('files'));
      if(files.length !== 0){
        for(let i = 0; i < files.length; i++){ // 파일유형이 이미지인지 체크
          let filetype = files[i].type;
          let input = (i === 0) ? $('#thumbnail') : $('#product_images');
          if(filetype.substring(0, filetype.indexOf('/')) !== 'image') {
            fnToggleValid(input, true, ' * 이미지 파일만 첨부할 수 있습니다.');
            break;
          }
        }
      }
      
      // 공백/초과인 입력칸이 있을 경우 submit 안함
      if($(".not-empty").is(".is-invalid")){
        alert('아직 작성되지 않았거나 잘못된 입력사항이 있습니다.')
        return;
      }
      
      // 문제 없으면 SUBMIT
      $(this).parents('form').submit();
    });
  }
  
  const fnSetRating = () => {
    $(document).on('click', '.star', function(){
      $(this).prevAll('.star').text('★');
      $(this).text('★');
      $(this).nextAll('.star').text('☆');
      $('#reviewRating').val($(this).prevAll('.star').length + 1);
    })
  }
  
  
  fnFileCheck();
  fnOpenFileSelect();
  
  fnCheckInput();
  fnCheckRequired();
  
  fnSetRating();
  
</script>