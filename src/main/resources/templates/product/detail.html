<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/layout/header :: head('상품 상세')}"></head>
<style>
  #product_header{
    margin: 0 auto;
    width: 1280px;
    min-height: 754px;
  }     
  #product_detail{
    width: 450px;
    height: 100%;
  }
  #product_info h2 {
    font-weight: bold;
    margin: 30px 0;
    word-break: break-word;
      }
  #product_info .tab-content {
    padding: 20px 10px;
  }
  #product_sale_price {
    font-size: 28px;
    color: black;
  }
  #product_price {
    font-size: 23px;
    text-decoration: line-through;
  }
  #discount_percent {
    font-size: 28px;
    color: red;
  }
  #slideshow{
    width: 754px;
    height: 754px;
  }
  #product_images, .carousel-item{
    width: 100%;
    height: 100%;
    background-color: lightgray;
  }
  #product_images img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  #product_contents {
    width: 1280px;
    margin: 50px auto;
    padding-top: 30px;
    border-top: 1px solid gray;
    text-align: center;
  }
  #product_contents img {
    width: 850px;
    height: 100%;
  }
  figure {
    margin: 0;
  }
  #product_info .nav-item {
    width: 150px;
  }
  #total_price_area {
    margin-top: 15px;
    margin-bottom: 10px;
  }
  #btn_area {
    width: 100%;
    margin-bottom: 20px;
  }
  .selected_option {
    border-top: 1px solid gray;
  }
  .option_name {
    padding: 10px;
    width: 200px;
    font-weight: bold;
  }
  .option_count {
    padding: 10px;
    width: 150px;
  }
  #total_price {
    height: 100px;
    font-size: 50px;
    color: black;
    font-weight: bold;
  }
  #product_review{
    border-top: 1px solid gray;
    margin: 50px auto;
    padding: 30px;
    width: 1280px;
  }
  #product_rating {
    text-align: center;
    padding: 50px;
  }
  #average_rating {
    font-size: 50px;
    font-weight: bold;
    color: black;
  }
  .star {
    color: gold;
  }
  .review {
    border-top: 1px solid gray;
    padding: 30px;
    width: 100%;
  }
  .review_title, .review_contents {
    max-width: 900px;
  }
  .review_image{
    width: 200px;
    height: 200px;
    object-fit: contain;
  }
</style>
<body>
  <div th:replace="~{layout/header :: header}"></div>
  <div id="product_header" class="d-flex justify-content-center mt-5">
    <div id="slideshow" class="carousel slide me-5 d-flex align-items-center" data-bs-ride="carousel">
      <div id="product_images" class="carousel-inner">
        <div class="carousel-item active" th:if="${#lists.isEmpty(imageList)}">
          <img class="d-block w-100" th:src="@{/image/no_image.png}">
        </div>
        <th:block th:if="${not #lists.isEmpty(imageList)}">
          <th:block th:each="image, imageStat : ${imageList}">
            <th:block th:if="${image.position == 'display'}">
              <div class="carousel-item">
                <img class="d-block" th:src="|${image.path}/${image.filesystemName}|">
              </div>
            </th:block>
          </th:block>
        </th:block>
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#slideshow" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#slideshow" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    </div>
    <div id="product_detail">
      <div id="product_info">
        <div><h2 th:text="${product.productName}"></h2></div>
        <ul class="nav nav-tabs d-flex justify-content-center text-center" role="tablist">
          <li class="nav-item" role="presentation">
            <a class="nav-link active" data-bs-toggle="tab" href="#description" aria-selected="true" role="tab">설명</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" data-bs-toggle="tab" href="#size" aria-selected="false" role="tab" tabindex="-1">규격</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" data-bs-toggle="tab" href="#warning" aria-selected="false" role="tab" tabindex="-1">경고</a>
          </li>
        </ul>
        <div id="myTabContent" class="tab-content">
          <div class="tab-pane fade show active" id="description" role="tabpanel">
            <p style="white-space:pre;" th:text="${product.productDescription}"></p>
          </div>
          <div class="tab-pane fade" id="size" role="tabpanel">
            <p style="white-space:pre;" th:text="${product.productSize}"></p>
          </div>
          <div class="tab-pane fade" id="warning" role="tabpanel">
            <p style="white-space:pre;" th:text="${product.productWarning}"></p>
          </div>
        </div>
      </div>
      <div id="price_info" class="d-flex p-2">
        <span id="product_sale_price"><strong th:text="${product.productPrice * (100 - event.discountPercent) / 100}"></strong>원</span>
        <span id="product_price" class="p-1"><strong th:text="${product.productPrice}"></strong>원</span>
        <span id="discount_percent" class="ms-auto"><strong th:text="${event.discountPercent}"></strong>%</span>
      </div>
      <div class="p-2 d-flex justify-content-between align-items-center">
        <span style="width: 20%;">옵션</span>
        <div style="width: 80%;">
          <select id="option_list" class="form-select">
            <option value="0">(필수)옵션을 선택해주세요</option>
            <th:block th:each="option : ${optionList}">
              <option th:if="${option.optionCount > 0}" th:value="${option.optionNo}" th:data-add-price="${option.addPrice}" th:data-option-count="${option.optionCount}">
                <th:block th:text="|${option.optionName}(+${option.addPrice})|"></th:block>
                <span th:if="${option.optionCount < 10}" th:text="|품절임박: ${option.optionCount}개 남음|"></span>
              </option>
              <option th:if="${option.optionCount == 0}" class="text-danger" disabled>
                <th:block th:text="|${option.optionName}(+${option.addPrice})|"></th:block>
                <span th:text="  품절"></span>
              </option>
            </th:block>
          </select>
        </div>
      </div>
      <div>
        <form method="post" th:action="@{/order/addCart.do}" id="frm_cart_order">
          <div id="selected_option_list"></div>
        </form>
      </div>
      <div id="total_price_area">총 상품금액: <span id="total_price">0</span> 원</div>
      <div id="btn_area" class="btn-group">
        <button type="button" id="btn_add_cart" class="btn btn-light btn-lg">장바구니 담기</button>
        <button type="button" id="btn_add_order" class="btn btn-success btn-lg">바로 주문</button>
      </div>
      <th:block th:if="${session.user} != null">
        <form th:if="${session.user.adminAuthorState == 1}" id="frm_edit_remove_product">
          <input type="hidden" name="productNo" th:value="${product.productNo}">
          <button type="button" id="btn_edit_product" class="btn btn-light btn-lg">수정</button>
          <button type="button" id="btn_remove_product" class="btn btn-success btn-lg">삭제</button>
        </form>
      </th:block>
    </div>
  </div>
  <div id="product_contents" th:utext="${product.productContents}"></div>
  <div id="product_review">
    <h2>리뷰</h2>
    <div id="product_rating">
      <th:block th:if="${product.productRating != 0}">
        이 상품의 평점: 
        <span id="average_rating">
          <strong class="star" th:each="num:${#numbers.sequence(1, 5)}">
            <th:block th:if="${num} <= ${product.productRating}" class="star">★</th:block>
            <th:block th:if="${num} > ${product.productRating}" class="star">☆</th:block>
          </strong>
          <span th:text="${#numbers.formatDecimal(product.productRating, 1, 1)}"></span>
        </span>
      </th:block>
      <th:block th:if="${product.productRating == 0}">
        <span>아직 평점이 없습니다.</span>
      </th:block> 
    </div>
    <div id="review_list"></div>
  </div>
  <div th:replace="~{layout/footer :: footer}"></div>
</body>
<script th:inline="javascript">
  
  $(document).ready(function(){
    $('.carousel-item').first().addClass('active');
  });
  
  var user = /*[[${session.user}]]*/ null;
  var userNo = 0;
  if(user !== null){
    userNo = user.userNo;
  }
  var cartCount = 0;
  
  // 선택한 옵션 출력
  const fnAddOption = () => {
    $('#option_list').change(function() {
      var optionNo = $(this).val();
      if(optionNo === '0'){
        return;
      }
      var selected_optionNo_list = [];
      $.each($('#selected_option_list').children(), function(i, option) {
        selected_optionNo_list[i] = $(option).data('option-no');
      });
      if ($.inArray(parseInt(optionNo), selected_optionNo_list) !== -1){
        alert('이미 추가된 옵션입니다.');
        $(this).val("0");
        return;
      }
      let discountPercent = /*[[${event.discountPercent}]]*/ 0
      let productPrice = /*[[${product.productPrice}]]*/ 0;
      let optionName = $("#option_list option:selected").text();
      let addPrice = $("#option_list option:selected").data('add-price');
      let optionCount = $("#option_list option:selected").data('add-price');
      let str = '<div class="selected_option d-flex justify-content-between align-items-center" data-option-no="' + optionNo + '">';
      str += '  <div class="option_name">' + optionName + '</div>';
      str += '  <div class="d-flex pt-2 option_count">';
      str += '    <button type="button" class="btn btn-light minus_count">-</button>';
      str += '    <input type="hidden" name="cartList[' + cartCount + '].userDto.userNo" value="' + userNo + '">';
      str += '    <input type="hidden" class="option_no" name="cartList[' + cartCount + '].productOptionDto.optionNo" value="' + optionNo + '">';
      str += '    <input type="text" class="count form-control-plaintext text-center" value="1" name="cartList[' + cartCount + '].count" data-option-count="' + optionCount + '" readonly>';
      str += '    <button type="button" class="btn btn-light plus_count">+</button>';
      str += '    <button type="button" class="btn btn-light btn_delete_option">X</button>';
      str += '  </div>'
      str += '  <input type="hidden" class="option_price" value="' + Math.floor(productPrice * (100 - discountPercent) / 100 + addPrice) + '">';
      str += '  <div class="calculated_price_wrapper"><span class="calculated_price">' + Math.floor(productPrice * (100 - discountPercent) / 100 + addPrice) + '</span>원</td>';
      str += '</div>';
      $('#selected_option_list').append(str);
      $(this).val("0");
      cartCount += 1;
    });
  }
  
  // 선택한 옵션 삭제
  const fnDeleteOption = () => {
    $(document).on('click', '.btn_delete_option', function(){
      $(this).parents('.selected_option').remove();
      fnGetTotalPrice();
    });
  }
  
  // 옵션 수량 감소
  const fnDecreaseCount = () => {
    $(document).on('click', '.minus_count', function(){
      var count = $(this).siblings('.count');
      if(count.val() === '1'){
        alert('선택한 옵션의 개수는 1개 이상이어야 합니다.');
        return;
      }
        count.val(parseInt(count.val()) - 1); // 화면에 보이는 개수 감소
        var calculated_price = $(this).parent().siblings('.calculated_price_wrapper').find('.calculated_price'); // 계산된 가격
        var option_price = $(this).parent().siblings('.option_price'); // 옵션 가격
        var count = $(this).siblings('.count'); // 개수
        // 계산된 가격 = option_price(옵션가격) * count(개수)
        calculated_price.text(option_price.val() * count.val()).trigger('change');
    });
  }
  
  // 옵션 수량 증가
  const fnIncreaseCount = () => {
    $(document).on('click', '.plus_count', function(){
        var count = $(this).siblings('.count');
        if(count.val() >= count.data('option-count')){
          alert('해당 옵션의 재고가 부족합니다.');
          return;
        }
        count.val(parseInt(count.val()) + 1); // 화면에 보이는 개수 증가
        var calculated_price = $(this).parent().siblings('.calculated_price_wrapper').find('.calculated_price'); // 계산된 가격
        var option_price = $(this).parent().siblings('.option_price'); // 옵션 가격
        var count = $(this).siblings('.count'); // 개수
        // 계산된 가격 = option_price(옵션가격) * count(개수)
        calculated_price.text(option_price.val() * count.val()).trigger('change');
    });
  }
  
  // 상품번호
  var productNo = /*[[${product.productNo}]]*/ 0;
  
  const fnGetTotalPrice = () => {
    var total = 0;
    $.each($('.calculated_price'), (i, price) => {
      total += parseInt($(price).text());
    });
    $('#total_price').text(total);
  }
  
  const fnUpdateTotalPrice = () => {
    $(document).on('change', '#option_list, .calculated_price', function(){
      fnGetTotalPrice();
    });
  }
  
  const fnAddCartOrder = () => {
    $(document).on('click', '#btn_add_cart', function(){
      $('#frm_cart_order').attr('th:action', '@{/order/addCart.do}');
      $('#frm_cart_order').submit();
    })
    $(document).on('click', '#btn_add_order', function(){
      $('#frm_cart_order').attr('th:action', '@{/order/addOrder.do}');
      $('#frm_cart_order').submit();
    })
  }
  
  
  // 상품명
  var productName = /*[[${product.productName}]]*/ '상품명이 없습니다.';
  var page = 1;
  var order = 'REVIEW_CREATED_AT';
  const fnGetReviewList = () => {
    $.ajax({
      // 요청
      type: 'get',
      url: '/review/getReviewList.do',
      data: {'productNo' : productNo
           , 'page' : page
           , 'order' : order
            },
      // 응답
      dataType: 'json',
      success: (resData) => {  // resData = {"reviewList": [], "paging": ""}
        if(resData.reviewList === null){
          alert('리뷰 목록 불러오기 실패');
          return;
        }
        if(resData.reviewList.length === 0){
          $('#review_list').text('아직 리뷰가 없습니다.');
          return;
        }
        $.each(resData.reviewList, (i, review) => {
          let str = '<div class="review d-flex" data-review-no="' + review.reviewNo + '">';
          str += '<div>'
          str += '  <h4 class="star">';
          str += '★'.repeat(review.reviewRating) + '☆'.repeat(5 - review.reviewRating);
          str += '  </h4>';
          str += '  <div>' + review.userDto.name + '  ' + review.reviewModifiedAt + '</div>';
          str += '  <div>상품명: ' + productName + ' / 옵션: ' + review.productOptionDto.optionName + '</div>';
          if(review.reviewTitle !== null){
            str += '  <h5 class="review_title mt-2 text-break">' + review.reviewTitle + '</h5>'
          }
          if(review.reviewContents !== null){
            str += '  <div class="review_contents text-break">' + review.reviewContents + '</div>';
          }
          str += '</div>'
          if(review.reviewImageDto !== null){
            str += '<image class="review_image ms-auto" src="' + review.reviewImageDto.path + '/' + review.reviewImageDto.filesystemName + '">';
          } else {
            str += '<image class="review_image ms-auto" src="/image/no_image.png">';
          }
          str += '</div>';
          $('#review_list').append(str);
        });
        $('#review_list').append(resData.paging);
      }
    })
  }
  
  function fnEditProduct(){
    $(document).on('click', '#btn_edit_product', function(){
      if(!confirm('이 제품을 수정하시겠습니까?')){
        return;
      }
      let form = $(this).parents('form');
      $(form).attr('method', 'get');
      $(form).attr('action', '/product/editProduct.form');
      $(form).submit();
    });
  }
  
  function fnRemoveProduct(){
    $(document).on('click', '#btn_remove_product', function(){
      if(!confirm('이 제품을 삭제하시겠습니까?')){
        return;
      }
      let form = $(this).parents('form');
      $(form).attr('method', 'post');
      $(form).attr('action', '/product/removeProduct.do');
      $(form).submit();
    });
  }
  
  const fnEditProductResult = () => {
    let editProductResult = /*[[${editProductResult}]]*/ null;  // '', true, false
    if(editProductResult !== null){
      if(editProductResult === true){
        alert('성공적으로 수정되었습니다.');
      } else {
        alert('상품 수정에 실패하였습니다.');
      }
    }
  }
  
  fnAddOption();
  fnDeleteOption();
  fnDecreaseCount();
  fnIncreaseCount();
  fnUpdateTotalPrice();
  fnAddCartOrder();
  fnGetReviewList();
  fnEditProduct();
  fnRemoveProduct();
  fnEditProductResult();
  
</script>