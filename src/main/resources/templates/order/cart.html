<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{/layout/header::head('cart')}"></head>

<style>
  .img_line1 {
    
  }
  .img_line2 {
    
  }
  
</style>

<body>

  <div th:replace="~{/layout/header::header}"></div>
  <div>
    
  </div>

  <h1>Cart</h1>
  <hr>
  
  <div>
    <div>
      <h3>일반상품</h3>
    </div>
    <form id="frm_btn"> 
      <table border="1" class="b">
        <thead>
          <tr>
            <th class="img_line1">이미지</th>
            <th class="img_line2">상품명</th>
            <th class="img_line">판매가</th>
            <th class="img_line">수량</th>
            <th class="img_line">적립금</th>
            <th class="img_line">배송</th>
            <th class="img_line">상품합계</th>
          </tr>
        </thead>
        <tbody>
        <caption>장바구니</caption>
          <th:block th:each="cartProduct:${cartList}"> 
            <tr class="a">
              <td class="cart_info_td">
                <input type="checkbox" class="cart_checkbox" checked="checked">
                <input type="image" class="image" th:value="이미지">
                <input type="text" class="pr_Name" th:value="${cartProduct.productDto.productName}" readonly>
                <input type="text" class="pr_Price" th:value="${cartProduct.productDto.productPrice}"readonly>
                <input type="text" class="deliveryPrice" th:value="3000원"readonly>
                <input type="text" class="finaltotalprice" th:value="${(cartProduct.productDto.productPrice + cartProduct.productOptionDto.addPrice) * cartProduct.count + 3000}" readonly>
                <input type="text" class="" th:value="적립금">
                  <span id="count_span">
                    <input type="" class="totalCount" th:value="${cartProduct.count}" readonly>
                    <button type="button" class="plus_btn" th:value="${cartProduct.count}">+</button>
                    <input type="hidden" class="plus_cartcount" name="count" th:value="${cartProduct.count}"></input>
                    <button type="button" class="minus_btn" th:value="${cartProduct.count}">-</button>
                    <input type="hidden" class="minus_cartcount" name="count" th:value="${cartProduct.count}"></input>
                  </span>
                <input type="hidden" name="userNo" th:value="${cartProduct.userDto.userNo}">
                <input type="hidden" name="optionNo" class="delete_option" th:value="${cartProduct.productOptionDto.optionNo}">
                <button type="submit"  class="btn_remove">삭제</button>
              </td>
            </tr>  
          </th:block>
        </tbody>
        </table>
      </form>
      
  <hr>
    
    
    <div>
      <form id="frm_order">
        <table border="1">
          <thead>
          </thead>
          <tbody>
            <tr>
              <td><span class="totalPrice_span"></span></td> 
              <td><span class="totalCount_span"></span></td>
              <td><span class="delivery_price"></span></td>
              <td><span class="finalTotalPrice_span"></span></td>
            </tr>
          </tbody>
        </table>
        <div>
          <a th:href="@{/order/order.do}">
            <button type="button">구매</button>
          </a>
          <a th:href="@{/product/list.do}">
            <button type="button">리스트로 돌아가기</button>
          </a>
      </div>
    </form>
   </div>
    
    
    
    
 
 </div>

<script th:inline="javascript">
   
   $(document).ready(function(){
       setTotalInfo();
      
   
   $('.cart_checkbox').on('change', function(){
      setTotalInfo($('.cart_info_td'));
   });
   
   function setTotalInfo(){
      
      var totalPrice = 0;                                        // 상품 가격
      var totalCount = 0;                                        // 총 갯수
      var totalKind = 0;                                         // 총 종류
      var totalPoint = 0;                                        // 총 마일리지
      var deliveryPrice = 0;                                     // 배송비
      var finalTotalPrice = 0;  
      
    
    $('.cart_info_td').each(function(index, e){
         if($(e).find('.cart_checkbox').is(':checked') === true){
           totalPrice += parseInt($(e).find('.finaltotalprice').val());
           console.log(JSON.stringify(totalPrice));
           totalCount += parseInt($(e).find('.totalCount').val());
           console.log(JSON.stringify(totalCount));
           totalKind += 1;
         }
           
      });
      
      if(totalPrice >= 30000){
         deliveryPrice = 0;
      } else if(totalPrice == 0){
         deliveryPrice = 0;
      } else {
         deliveryPrice = 3000;   
      }
      
      finalTotalPrice = totalPrice + deliveryPrice;
      // 총가격
      $('.totalPrice_span').text(totalPrice.toLocaleString());
      // 총 갯수
      $(".totalCount_span").text(totalCount);
      // 총 종류
      $(".totalKind_span").text(totalKind);
      // 배송비
      $(".delivery_price").text(deliveryPrice);   
      // 최종 가격(총 가격 + 배송비)
      $(".finalTotalPrice_span").text(finalTotalPrice.toLocaleString());
   
      
   }
   });

</script>

<script th:inline="javascript">
          
  const fnMinusCount = () => {
    $(document).on('click', '.minus_btn', function(ev){
      var count = $(this).next().val();
      console.log(count);
      if(count == '1'){
        alert('상품을 더이상 줄일수 없습니다.');
        return;
      }
        $.ajax({
           type: 'post',
           url: '/order/minusupdate.do',
           data:$('#frm_btn').serialize(),
           dataType: 'json',
           success: (resData) => {
             location.reload();
             setTotalInfo();
           }
        });
     });
   }
  
  const fnPlusCount = () => {
    $(document).on('click', '.plus_btn', function(ev){
        var count = $(this).next().val();
        if(count == '100'){
          alert('상품을 더 담을수 없습니다.')
          return;
        }
          $.ajax({
          type: 'post',
          url: '/order/plusupdate.do',
          data:$('#frm_btn').serialize(),
          dataType: 'json',
          success: (resData) => {
            location.reload();
            setTotalInfo();
           }
        });
    });
  }
  
  
  
  const fnDeleteCart = () => {
        $(document).on('click', '.btn_remove', (ev) => {
          if(!confirm('상품을 삭제할까요?')){
             return;
           }
          $.ajax({
            type: 'post',
            url: '/order/delete.do',
            data:$('#frm_btn').serialize(),
            dataType: 'json',
            success: (resData) => {  
               if(resData.removeResult === 1){
                  alert('상품삭제를 취소합니다.');
                     location.reload();
                  } else {
                  alert('상품이 삭제되었습니다.');
                     location.reload();
               }
             }
           })
       })
     }
     
       
  fnPlusCount();
  fnDeleteCart();
  fnMinusCount();
</script>



</body>
</html>